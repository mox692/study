%Date%:20210409
%source%:https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf

## 概要

## 要約
### Abstruct
* 世界最大級のeコマースシステムを持つamazonにとって、システムの信頼性はとても重要である
* amazonにおける、可用性の高いkey-value systemであるdynamoのデザインを説明する
* 高いレベルの可用性を実現するために、dynamoは障害時において(一時的な)一貫性を犠牲にする
### Introduction
* amazonの長いoperationの中で培われてきた教訓としては、信頼性とスケーラビリティは、applicationの状態がどのように管理されているかにかかっている.
  * 例えば、customerがshopping cartに品を入れた時は、裏でどんな障害が起こっていようとも、その操作が完了されないといけない.
  * つまり、常にwrite, readが可能出なければいけない
* 
### Background
* 
* 


### 3. Related Work
#### 3.1 Peer to Peer Systems
* p2pとかoverlay network全然詳しくなかったけど、これきっかけで調べたら結構おくが深そう.
* overlay networkがナチュアるに浸透してて存在に気づいていないだけ説もある.以下、妄想.
  * zoom会議
    * 明らかにserver-clientモデルではない
    * ただし、送信先が頻繁に変わるわけではないから、宛先の検索速度の用件はそこまで高くない？
  * google docsのファイルの共同編集
    * a
  * youtube liveの配信
    * 配信者が唯一のserver,閲覧者がclientってモデルだと、serverが死にそう
    * wikiに書いてあった気がするけど、配信を見ているclient自身も配信の内容をbufferingして、client自身もserverになるみたいな構成はアリエル？

#### 3.2 Distributed File Systems and Databases
* *伝統的なレプリケートするリレーショナルデータベースはレプリカデータに強一貫性を保証するための問題にフォーカスしています。強一貫性はアプリケーション開発者に便利なプログラミングモデルを提供するのですが、これらのシステムはスケーラビリティと可用性が限定されてしまいます*
  * これらから、dynamoでは一貫性を犠牲にして可用性を高めていることが再び強調されている？

#### 3.3 Discussion
* dynamoのusecaseがまとめられてる. ここだけ見れば良さげ?

## 発見

## 疑問
* 衝突解決手続き = raft 的なこと?

## その他
* [日本語訳](https://gist.github.com/nashibao/4031679)

### 本文翻訳
## Abstruction
大規模な信頼性は、世界最大のeコマースオペレーションの1つであるAmazon.comで直面する最大の課題の1つです。わずかな停止でも、重大な経済的影響があり、顧客の信頼に影響を与えます。世界中の多くのWebサイトにサービスを提供するAmazon.comプラットフォームは、世界中の多くのデータセンターにある数万のサーバーとネットワークコンポーネントのインフラストラクチャ上に実装されています。この規模では、大小のコンポーネントが故障します
継続的に、これらの障害に直面して永続的な状態を管理する方法は、
ソフトウェアシステム。このホワイトペーパーでは、Amazonのコアサービスの一部が「常時接続」エクスペリエンスを提供するために使用する、可用性の高いKey-ValueストレージシステムであるDynamoの設計と実装について説明します。このレベルの可用性を実現するために、Dynamoは特定の障害シナリオで一貫性を犠牲にします。これは、開発者が使用するための新しいインターフェースを提供する方法で、オブジェクトのバージョン管理とアプリケーション支援の競合解決を広範囲に使用します。

## Introduction
Amazonは、世界中の多くのデータセンターにある数万のサーバーを使用して、ピーク時に数千万の顧客にサービスを提供する世界規模のeコマースプラットフォームを実行しています。 Amazonのプラットフォームには、パフォーマンス、信頼性、効率の点で厳格な運用要件があり、継続的な成長をサポートするには、プラットフォームが高度にスケーラブルである必要があります。わずかな停止でも重大な経済的影響を及ぼし、顧客の信頼に影響を与えるため、信頼性は最も重要な要件の1つです。さらに、継続的な成長をサポートするには、プラットフォームが高度にスケーラブルである必要があります。組織がAmazonのプラットフォームの運用から学んだ教訓の1つは、システムの信頼性とスケーラビリティは、アプリケーションの状態の管理方法に依存するということです。数百のサービスで構成される、疎結合のサービス指向アーキテクチャ。この環境では、常に利用可能なストレージテクノロジーが特に必要です。たとえば、ディスクに障害が発生したり、ネットワークルートがフラッピングしたり、データセンターが竜巻によって破壊されたりした場合でも、顧客は商品を表示してショッピングカートに追加できる必要があります。したがって、ショッピングカートの管理を担当するサービスでは、データストアへの書き込みとデータストアからの読み取りが常に可能であり、データが複数のデータセンターで利用可能である必要があります。数百万のコンポーネントで構成されるインフラストラクチャの障害に対処することが、当社の標準的な運用モードです。常に少数ですが、かなりの数のサーバーおよびネットワークコンポーネントが常に故障しています。そのため、Amazonのソフトウェアシステムは、可用性やパフォーマンスに影響を与えることなく、障害処理を通常のケースとして扱う方法で構築する必要があります。信頼性とスケーリングのニーズを満たすために、Amazonは多くのストレージテクノロジーを開発しました。アマゾンとアマゾンS3として知られている）は、おそらく最もよく知られています。このホワイトペーパーでは、Amazonのプラットフォーム向けに構築されたもう1つの高可用性でスケーラブルな分散データストアであるDynamoの設計と実装について説明します。Dynamoは、非常に高い信頼性要件があり、可用性、一貫性、費用対効果、パフォーマンスの間のトレードオフを厳密に制御する必要があるサービスの状態を管理するために使用されます。 。 Amazonのプラットフォームには、さまざまなストレージ要件を持つ非常に多様なアプリケーションのセットがあります。

Amazonのプラットフォームには、データストアへのプライマリキーアクセスのみを必要とする多くのサービスがあります。ベストセラーリスト、ショッピングカート、顧客設定、セッション管理、販売ランク、製品カタログを提供するサービスなど、多くのサービスでは、リレーショナルデータベースを使用する一般的なパターンにより、非効率になり、規模と可用性が制限されます。 Dynamoは、これらのアプリケーションの要件を満たすために、シンプルな主キーのみのインターフェイスを提供します。Dynamoは、拡張性と可用性を実現するために、よく知られた手法の統合を使用します。データは、コンシステントハッシュ法[10]を使用してパーティション化および複製され、オブジェクトのバージョニング[12]によって一貫性が促進されます。更新中のレプリカ間の一貫性は、クォーラムのような手法と分散型レプリカ同期プロトコルによって維持されます。


## Background
Amazonのeコマースプラットフォームは、推奨事項から注文処理、不正検出に至るまでの機能を提供するために連携して機能する何百ものサービスで構成されています。各サービスは、明確に定義されたインターフェイスを介して公開され、ネットワーク経由でアクセスできます。これらのサービスは、世界中の多くのデータセンターに配置された数万台のサーバーで構成されるインフラストラクチャでホストされています。これらのサービスの一部はステートレス（つまり、他のサービスからの応答を集約するサービス）であり、一部はステートフル（つまり、状態に格納された永続ストアでビジネスロジックを実行することによって応答を生成するサービス）です。従来、本番システムは、その状態をリレーショナルデータベースに格納します。ただし、ステートパーシスタンスのより一般的な使用パターンの多くでは、リレーショナルデータベースは理想からはほど遠いソリューションです。これらのサービスのほとんどは、プライマリキーごとにデータを保存および取得するだけであり、RDBMSによって提供される複雑なクエリおよび管理機能を必要としません。この過剰な機能は、その操作に高価なハードウェアと高度なスキルを必要とするため、非常に非効率的なソリューションになります。さらに、利用可能なレプリケーションテクノロジーは限られており、通常、可用性よりも一貫性を選択します。近年、多くの進歩が見られますが、データベースをスケールアウトしたり、負荷分散にスマートパーティショニングスキームを使用したりすることは依然として容易ではありません。このホワイトペーパーでは、これらの重要なサービスクラスのニーズに対応する高可用性データストレージテクノロジーであるDynamoについて説明します。 Dynamoは、シンプルなキー/値インターフェイスを備え、明確に定義された整合性ウィンドウで高い可用性を備え、リソースの使用効率が高く、データセットサイズまたはリクエストレートの増加に対応するためのシンプルなスケールアウトスキームを備えています。 Dynamoを使用する各サービスは、独自のDynamoインスタンスを実行します

.2.1システムの前提条件と要件

このクラスのサービスのストレージシステムには、次の要件があります。クエリモデル：キーによって一意に識別されるデータ項目への単純な読み取りおよび書き込み操作。状態は、一意のキーで識別されるバイナリオブジェクト（つまり、ブロブ）として保存されます。複数のデータ項目にまたがる操作はなく、リレーショナルスキーマも必要ありません。この要件は、Amazonのサービスの大部分がこの単純なクエリモデルで機能し、リレーショナルスキーマを必要としないという観察に基づいています。 Dynamoは、比較的小さい（通常は1 MB未満）オブジェクトを格納する必要があるアプリケーションを対象としています。ACIDプロパティ：ACID（Atomicity、Consistency、Isolation、Durability）は、データベーストランザクションが確実に処理されることを保証する一連のプロパティです。データベースのコンテキストでは、データに対する単一の操作はトランザクションと呼ばれます。Amazonでの経験から、ACID保証を提供するデータストアは可用性が低い傾向があることが示されています。これは、産業界と学界の両方で広く認められています[5]。Dynamoは、高可用性が得られる場合、一貫性の低いアプリケーション（ACIDの「C」）を対象としています。 Dynamodoesは、分離の保証を提供せず、単一キーの更新のみを許可します。効率：システムは、コモディティハードウェアインフラストラクチャで機能する必要があります。 Amazonのプラットフォームでは、サービスには厳しいレイテンシ要件があり、これは一般に、分布の99.9パーセンタイルで測定されます。状態アクセスがサービス運用において重要な役割を果たすことを考えると、ストレージシステムはそのような厳格なSLAを満たすことができなければなりません（以下のセクション2.2を参照）。サービスは、レイテンシとスループットの要件を一貫して達成するようにDynamoを構成できる必要があります。トレードオフは、パフォーマンス、コスト効率、可用性、および耐久性の保証です。その他の前提条件：DynamoはAmazonの内部サービスでのみ使用されます。その運用環境は非敵対的であると想定されており、認証や承認などのセキュリティ関連の要件はありません。さらに、各サービスはDynamoの個別のインスタンスを使用するため、初期設計では最大数百のストレージホストの規模を対象としています。 Dynamoのスケーラビリティの制限と、スケーラビリティに関連する拡張機能については、後のセクションで説明します。


2.2サービスレベルアグリーメント（SLA）
アプリケーションがその機能を十分な時間で提供できることを保証するために、プラットフォーム内のすべての依存関係は、さらに厳しい範囲でその機能を提供する必要があります。クライアントとサービスは、サービスレベルアグリーメント（SLA）を締結します。これは、クライアントとサービスがいくつかのシステム関連の特性について合意する正式な交渉による契約です。これには、特定のAPIに対するクライアントの予想される要求率の分布と、それらの条件下での予想されるサービス遅延が含まれます。単純なSLAの例は、毎秒500リクエストのピーククライアント負荷に対するリクエストの99.9％に対して300ミリ秒以内に応答を提供することを保証するサービスです。Amazonの分散型サービス指向インフラストラクチャでは、SLAが重要な役割を果たします。たとえば、eコマースサイトの1つへのページリクエストでは、通常、レンダリングエンジンが、150を超えるサービスにリクエストを送信して応答を構築する必要があります。これらのサービスには、多くの場合、他のサービスである複数の依存関係があるため、複数のレベルを持つアプリケーション。ページレンダリングエンジンが明確な境界ページ配信を維持できるようにするには、コールチェーン内の各サービスがそのパフォーマンスコントラクトに従う必要があります。図1は、動的Webコンテンツがページレンダリングコンポーネントによって生成されるAmazonのプラットフォームのアーキテクチャの抽象的なビューを示しています。他の多くのサービスに問い合わせます。 Aserviceは、さまざまなデータストアを使用してその状態を管理できます。これらのデータストアには、サービスの境界内でのみアクセスできます。一部のサービスは、他のいくつかのサービスを使用して複合応答を生成することにより、アグリゲーターとして機能します。通常、アグリゲーターサービスはステートレスですが、広範なキャッシングを使用します。パフォーマンス指向のSLAを形成するための業界での一般的なアプローチは、平均、中央値、および期待される分散を使用して説明することです。アマゾンでは、大多数だけでなくすべての顧客が優れたエクスペリエンスを提供するシステムを構築することが目標である場合、これらのメトリックは十分ではないことがわかりました。たとえば、広範なパーソナライズ手法が使用されている場合、履歴が長い顧客はより多くの処理を必要とし、ディストリビューションのハイエンドでのパフォーマンスに影響を与えます。平均または中央値の応答時間の観点からSLAstatedは、この重要な顧客セグメントのパフォーマンスに対応しません。この問題に対処するために、Amazonでは、SLAは分布の99.9パーセンタイルで表現および測定されます。さらに高いパーセンタイルよりも99.9％を選択したのは、パフォーマンスを大幅に改善するためのコストの大幅な増加を示した費用対効果分析に基づいています。 Amazonの本番システムでの経験から、このアプローチは、平均または中央値に基づいて定義されたSLAを満たすシステムと比較して、全体的なエクスペリエンスが優れていることが示されています。このホワイトペーパーでは、この99.9パーセンタイルの分布について多くの言及があり、Amazonエンジニアの執拗な集中パフォーマンスを反映しています。顧客の経験の観点から。多くの論文は平均について報告しているので、比較のために意味のあるところにこれらが含まれています。それにもかかわらず、Amazonのエンジニアリングと最適化の取り組みは平均に焦点を合わせていません。書き込みコーディネーターの負荷分散された選択など、いくつかの手法は、99.9パーセンタイルでパフォーマンスを目標としています。特に、多くのAmazonサービスの場合のように、ビジネスロジックが比較的軽量である場合、ストレージシステムはサービスのSLAを確立する上で重要な役割を果たすことがよくあります。その後、状態管理がサービスのSLAの主要コンポーネントになります。 Dynamoの主な設計上の考慮事項の1つは、耐久性や一貫性などのシステムプロパティをサービスが制御できるようにし、サービスが機能と有効性の間で独自のトレードオフを行えるようにすることです。

2.3設計上の考慮事項
非商用システムで使用されるデータレプリケーションアルゴリズムは、一貫性の高いデータアクセスインターフェイスを提供するために、従来から同期レプリカ調整を実行します。このレベルの一貫性を実現するために、これらのアルゴリズムは、特定の障害シナリオでデータの可用性をトレードオフすることを余儀なくされています。たとえば、回答の正しさの不確実性に対処するのではなく、データが正しいことが絶対的に確実になるまで、データは使用できなくなります。非常に初期の複製されたデータベースの動作から、ネットワーク障害の可能性に対処する場合、強力な一貫性と高いデータ可用性を同時に達成できないことはよく知られています[2、11]。そのようなシステムとアプリケーションは、どのプロパティがどの条件下で達成できるかを認識する必要があります。サーバーとネットワークの障害が発生しやすいシステムの場合、変更をバックグラウンドでレプリカに伝播できる楽観的なレプリケーション手法と、同時の切断された作業を使用することで、可用性を高めることができます。許容されます。このアプローチの課題は、検出および解決する必要のある競合する変更につながる可能性があることです。この紛争解決のプロセスは、2つの問題を引き起こします。それは、いつ解決するか、誰が解決するかです。 Dynamoは、結果整合性のあるデータストアになるように設計されています。つまり、すべての更新が最終的にすべてのレプリカに到達します。重要な設計上の考慮事項は、更新の競合を解決するプロセスをいつ実行するか、つまり、読み取りまたは書き込み中に競合を解決する必要があるかどうかを決定することです。多くの従来のデータストアは、書き込み中に競合解決を実行し、読み取りの複雑さを単純に保ちます[7]。このようなシステムでは、データストアが指定された時間にすべて（または大部分）のレプリカに到達できない場合、書き込みが拒否されることがあります。一方、Dynamoは、「常に書き込み可能な」データストア（つまり、書き込みに非常に利用しやすいデータストア）のデザインスペースを対象としています。多くのAmazonサービスでは、カスタマーアップデートを拒否すると、カスタマーエクスペリエンスが低下する可能性があります。たとえば、ショッピングカートサービスでは、ネットワークやサーバーに障害が発生した場合でも、顧客がショッピングカートにアイテムを追加したり削除したりできるようにする必要があります。この要件により、書き込みが拒否されないようにするために、競合解決の複雑さを読み取りにプッシュする必要があります。次の設計上の選択は、競合解決のプロセスを実行するユーザーです。これは、データストアまたはアプリケーションで実行できます。競合の解決がデータストアによって行われる場合、その選択肢はかなり制限されます。このような場合、データストアは、競合する更新を解決するために、「最後の書き込みの勝利」[22]などの単純なポリシーのみを使用できます。一方、アプリケーションはデータスキーマを認識しているため、クライアントのエクスペリエンスに最適な競合解決方法を決定できます。たとえば、顧客のショッピングカートを維持するアプリケーションは、競合するバージョンを「マージ」して、単一の統合されたショッピングカートを返すことを選択できます。この柔軟性にもかかわらず、一部のアプリケーション開発者は、独自の競合解決メカニズムを記述せず、それをデータストアにプッシュダウンすることを選択する場合があります。データストアは、「最後の書き込みが優先される」などの単純なポリシーを選択します。

3.関連する仕事
3.1ピアツーピアシステム
データの保存と配布の問題を検討しているピアツーピア（P2P）システムがいくつかあります。 FreenetやGnutella1などの第1世代のP2Pシステムは、主にファイル共有システムとして使用されていました。これらは、ピア間のオーバーレイリンクが任意に確立された非構造化P2Pネットワークの例です。これらのネットワークでは、検索クエリは通常、データを共有するできるだけ多くのピアを見つけるためにネットワークを介してフラッディングされます。 P2Pシステムは、構造化P2Pネットワークとして広く知られているものへと次世代に進化しました。これらのネットワークは、グローバルに一貫性のあるプロトコルを採用して、任意のノードが目的のデータを持つピアに検索クエリを効率的にルーティングできるようにします。 Pastry[16]やChord[20]のようなシステムは、ルーティングメカニズムを使用して、制限されたホップ数内でクエリに応答できるようにします。マルチホップルーティングによって生じる追加の遅延を減らすために、一部のP2Pシステム（[14]など）はO（1）ルーティングを採用しており、各ピアはローカルで十分なルーティング情報を維持して、リクエストを（データアイテムにアクセスするために）適切なピアにルーティングできるようにします。一定のホップ数。Oceanstore[9]やPAST[17]などのさまざまなストレージシステムが、これらのルーティングオーバーレイの上に構築されました。 Oceanstoreは、広く複製されたデータのシリアル化された更新をサポートする、グローバルなトランザクション型の永続ストレージサービスを提供します。広域ロックに固有の問題の多くを回避しながら同時更新を可能にするために、競合解決に基づく更新モデルを使用します。競合の解決は、トランザクションの中止の数を減らすために[21]で導入されました。 Oceanstoreは、一連の更新を処理し、それらの中から全順序を選択してから、それらをアトミックにその順序で適用することにより、競合を解決します。これは、信頼できないインフラストラクチャでデータが複製される環境向けに構築されています。比較すると、PASTは、永続的で不変のオブジェクトに対して、Pastryの上に単純な抽象化レイヤーを提供します。アプリケーションがその上に必要なストレージセマンティクス（可変ファイルなど）を構築できることを前提としています。

3.2分散ファイルシステムとデータベース

パフォーマンス、可用性、および耐久性に関するデータの配布は、ファイルシステムおよびデータベースシステムコミュニティで広く研究されています。フラットな名前空間のみをサポートするP2Pストレージシステムと比較すると、分散ファイルシステムは通常、階層的な名前空間をサポートします。 Ficus[15]やCoda[19]のようなシステムは、一貫性を犠牲にして高可用性のためにファイルを複製します。更新の競合は通常、特殊な競合解決手順を使用して管理されます。 Farsiteシステム[1]は、NFSのような集中型サーバーを使用しない分散ファイルシステムです。 Farsiteは、レプリケーションを使用して高可用性とスケーラビリティを実現します。 Googleファイルシステム[6]は、Googleの内部アプリケーションの状態をホストするために構築されたもう1つの分散ファイルシステムです。 GFSは、メタデータ全体をホストし、データがチャンクに分割されて保存されたインチカンクサーバーである単一のマスターサーバーを備えたシンプルな設計を使用します。バイユーは、切断された操作を可能にし、最終的なデータの一貫性を提供する分散型リレーショナルデータベースシステムです[21]。これらのシステムの中で、バイユー、コーダ、フィカスは切断された操作を可能にし、ネットワークパーティションや停止などの問題に耐性があります。これらのシステムは、競合の解決手順が異なります。たとえば、CodaとFicusはシステムレベルの競合解決を実行し、Bayouはアプリケーションレベルの解決を許可しますが、これらはすべて結果整合性を保証します。これらのシステムと同様に、Dynamoは、ネットワークパーティション間でも読み取りおよび書き込み操作を続行し、さまざまな競合解決メカニズムを使用して更新された競合を解決します。FAB[18]などの分散ブロックストレージシステムは、大きなサイズのオブジェクトを小さなブロックに分割し、各ブロックを可用性の高い方法で保存します。これらのシステムと比較すると、この場合、Key-ValueStoreの方が適しています。これは、（a）比較的小さいオブジェクト（サイズ<1M）を格納することを目的としており、（b）Key-Valueストアはアプリケーションごとに構成するのが簡単だからです。 。 Antiquityは、複数サーバーの障害を処理するように設計された広域分散ストレージシステムです[23]。安全なログを使用してデータの整合性を維持し、耐久性のために複数のサーバーで各ログを複製し、ビザ​​ンチンのフォールトトレランスプロトコルを使用してデータの整合性を確保します。古代とは対照的に、Dynamoはデータの整合性とセキュリティの問題に焦点を当てておらず、信頼できる環境向けに構築されています。Bigtableは、構造化データを管理するための分散ストレージシステムです。スパースで多次元のソートされたマップを維持し、アプリケーションが複数の属性を使用してデータにアクセスできるようにします[2]。 Bigtableと比較して、Dynamoは、キー/値アクセスのみを必要とするアプリケーションを対象としており、ネットワークパーティションやサーバー障害が発生した場合でも、更新が拒否されない高可用性に主に焦点を当てています。従来のレプリケートされたリレーショナルデータベースシステムは、レプリケートされたデータに強い整合性を保証する問題に焦点を当てています。強い整合性はアプリケーションライターに便利なプログラミングモデルを提供しますが、これらのシステムは拡張性と可用性に制限があります[7]。 これらのシステムは、通常、強力な一貫性を保証するため、ネットワークパーティションを処理できません。


3.3ディスカッション
Dynamoは、ターゲット要件の点で前述の分散型ストレージシステムとは異なります。まず、Dynamoは主に、障害や同時書き込みによって更新が拒否されない「常に書き込み可能な」データストアを必要とするアプリケーションを対象としています。これは、多くのAmazonアプリケーションにとって重要な要件です。次に、前述のように、Dynamoは、すべてのノードが信頼できると想定される単一の管理ドメイン内のインフラストラクチャ用に構築されています。第3に、Dynamoを使用するアプリケーションは、階層名前空間（多くのファイルシステムではanorm）または複雑なリレーショナルスキーマ（従来のデータベースでサポート）のサポートを必要としません。第4に、Dynamoは、読み取りおよび書き込み操作の少なくとも99.9％を数百ミリ秒以内に実行する必要がある遅延に敏感なアプリケーションを構築します。これらの厳しいレイテンシ要件を満たすには、複数のノードを介したリクエストのルーティングを回避することが不可欠でした（これは、ChordやPastryなどのいくつかの分散ハッシュテーブルシステムで採用されている一般的な設計です）。これは、マルチホップルーティングによって応答時間の変動が大きくなり、それによって高いパーセンタイルでの遅延が増えるためです。 Dynamoは、ゼロホップDHTとして特徴付けることができます。この場合、各ノードは、要求を適切なノードに直接ルーティングするのに十分なルーティング情報をローカルに維持します。
